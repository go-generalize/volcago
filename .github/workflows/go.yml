name: Go

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      firestore:
        image: google/cloud-sdk
        ports:
          - 8000:8000
        options: -ti

    env:
      GO111MODULE: on
      FIRESTORE_EMULATOR_HOST: 127.0.0.1:8000

    steps:
      - name: Start Firestore
        uses: mickfeech/firestore-emulator-action@0.0.12
        with:
          fireStoreProjectID: pname

      - name: Set up Go 1.18
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
        id: go

      - uses: actions/checkout@v3

      - name: Ensure samples are generated
        env:
          TZ: Asia/Tokyo
        run: |
          export PATH=$PATH:$PWD/bin
          make gen_samples
          
          clean=$(git status | grep "nothing to commit" || true)
          if [ -z "$clean" ]; then
            git diff
            echo 'Please run "make gen_samples"'
            exit 1
          fi

      - name: Run tests
        run: |
          make test TEST_OPT='-tags="emulator"'
